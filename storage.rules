rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // ===== HELPER FUNCTIONS =====
    
    // Helper: Auth check
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper: Admin check (CONSISTENT WITH FIRESTORE RULES)
    // Uses same email list as Firestore rules
    function isAdmin() {
      return request.auth != null && request.auth.token.email in [
        'gangwalparul19@gmail.com',
        'rentanythingindia@gmail.com'
      ];
    }
    
    // Helper: Size limit (e.g. 5MB)
    function isImageBelowSize(sizeMB) {
      return request.resource.size < sizeMB * 1024 * 1024;
    }

    // ===== STORAGE PATHS =====

    // LISTINGS: User can only upload to their OWN folder
    match /listings/{userId}/{fileName} {
      allow read: if true; // Public listings
      allow write: if isAuthenticated() 
                   && request.auth.uid == userId
                   && isImageBelowSize(5); 
    }

    // ID DOCUMENTS: PRIVATE! Only Owner or Admin can read.
    match /id_docs/{userId}/{fileName} {
      allow write: if isAuthenticated() && request.auth.uid == userId;
      // Read: Only the user themselves or admin
      allow read: if isAuthenticated() && (
        request.auth.uid == userId || 
        isAdmin()
      );
    }

    // PROFILES: Public read, owner write
    match /profiles/{userId}/{fileName} {
      allow read: if true;
      allow write: if isAuthenticated() && request.auth.uid == userId;
    }

    // DISPUTES: Evidence files
    match /disputes/{userId}/{fileName} {
      // Reporter can upload evidence for their disputes
      allow write: if isAuthenticated() && 
                   request.auth.uid == userId && 
                   isImageBelowSize(5);
      
      // Involved parties and admins can read
      allow read: if isAuthenticated() && (
        request.auth.uid == userId || 
        isAdmin()
      );
    }

    // SIGNATURES (For Agreements)
    match /signatures/{fileName} {
      allow read: if isAuthenticated(); // Parties need to see it
      allow write: if isAuthenticated() && isImageBelowSize(1); // Small files only
    }
    

    // DEFAULT: Deny all
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
