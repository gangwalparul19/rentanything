rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========== HELPER FUNCTIONS ==========
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // ========== ADMIN EMAIL CHECK ==========
    // Update this list with authorized admin email addresses
    function isAdmin() {
      return request.auth != null && request.auth.token.email in [
        'gangwalparul19@gmail.com',  // Primary Admin
        // Add more admin emails here as needed:
        'rentanythingindia@gmail.com'
      ];
    }

    // ========== USERS COLLECTION ==========
    match /users/{userId} {
      allow read: if true; // Public profiles
      allow write: if isOwner(userId) || isAdmin();
    }
    
    // ========== LISTINGS COLLECTION ==========
    match /listings/{listingId} {
      allow read: if true; // Public listings
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && 
        (resource.data.ownerId == request.auth.uid || isAdmin());
    }
    
    // ========== BOOKINGS COLLECTION ==========
    match /bookings/{bookingId} {
      allow read: if true; // Public for simplicity (could restrict to involved parties)
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
        (resource.data.ownerId == request.auth.uid || 
         resource.data.renterId == request.auth.uid ||
         isAdmin());
    }

    // ========== REVIEWS COLLECTION ==========
    match /reviews/{reviewId} {
      allow read: if true; // Public reviews
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin(); // Admins can moderate reviews
    }

    // ========== SOCIETIES COLLECTION ==========
    match /societies/{societyId} {
      allow read: if true;
      allow write: if isAuthenticated() || isAdmin();
    }

    // ========== SOCIETY REQUESTS COLLECTION ==========
    match /society_requests/{requestId} {
      allow read, write: if isAuthenticated() || isAdmin();
    }

    // ========== COMMUNITY REQUESTS COLLECTION ==========
    match /requests/{requestId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if (isAuthenticated() && resource.data.userId == request.auth.uid) || isAdmin();
    }

    // ========== CHATS COLLECTION ==========
    match /chats/{chatId} {
      allow create: if isAuthenticated();
      allow read, update: if (isAuthenticated() && 
        request.auth.uid in resource.data.participants) || isAdmin();
      
      match /messages/{messageId} {
        allow read, create: if isAuthenticated();
      }
    }

    // ========== NOTIFICATIONS COLLECTION ==========
    match /notifications/{notificationId} {
      allow create: if isAuthenticated();
      allow read, update, delete: if (isAuthenticated() && 
        resource.data.userId == request.auth.uid) || isAdmin();
    }

    // ========== FAVORITES COLLECTION ==========
    match /favorites/{favoriteId} {
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      allow read, delete: if (isAuthenticated() && 
        resource.data.userId == request.auth.uid) || isAdmin();
    }

    // ========== WISHLISTS COLLECTION ==========
    match /wishlists/{wishlistId} {
      allow create: if isAuthenticated() && 
        wishlistId.matches('^' + request.auth.uid + '_[a-zA-Z0-9]+$');
      allow read, update, delete: if (isAuthenticated() && 
        resource.data.userId == request.auth.uid) || isAdmin();
    }

    // ========== WAITLISTS COLLECTION ==========
    match /waitlists/{waitlistId} {
      allow create: if isAuthenticated() && 
        wishlistId.matches('^' + request.auth.uid + '_[a-zA-Z0-9]+$');
      allow read, update, delete: if (isAuthenticated() && 
        resource.data.userId == request.auth.uid) || isAdmin();
    }

    // ========== DISPUTES COLLECTION ==========
    match /disputes/{disputeId} {
      // Users can read disputes they're involved in, Admins can read all
      allow read: if isAdmin() || 
        (isAuthenticated() && 
         (resource.data.reporterId == request.auth.uid || 
          resource.data.respondentId == request.auth.uid));
      
      // Users can create disputes for their own bookings
      allow create: if isAuthenticated() && 
        request.resource.data.reporterId == request.auth.uid;
      
      // Only admins can update disputes (mediation)
      allow update: if isAdmin();
      
      // No one can delete disputes (audit trail)
      allow delete: if false;
    }

    // ========== REPORTS COLLECTION ==========
    match /reports/{reportId} {
      allow create: if isAuthenticated();
      allow read: if isAdmin() || 
        (isAuthenticated() && resource.data.reporterId == request.auth.uid);
      allow update, delete: if isAdmin(); // Admins can manage all reports
    }

    // ========== SHARE ANALYTICS COLLECTION ==========
    match /share_analytics/{shareId} {
      allow create: if true; // Anyone can track shares (including anonymous)
      allow read: if isAdmin(); // Only admins can view analytics
    }

    // ========== ENVIRONMENTAL IMPACT COLLECTIONS ==========
    match /environmental_impact/{impactId} {
      allow create: if isAuthenticated();
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow read: if isAdmin(); // Admins can view all
    }

    match /user_eco_profile/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && userId == request.auth.uid;
    }

    match /platform_stats/{statId} {
      allow read: if true; // Public stats
      allow write: if isAuthenticated(); // Users can increment
    }

    // ========== COMMUNITY FORUMS COLLECTIONS ==========
    match /forum_threads/{threadId} {
      allow read: if true; // Public within app
      allow create: if isAuthenticated() && 
        request.resource.data.authorId == request.auth.uid;
      allow update: if isAuthenticated() && 
        (resource.data.authorId == request.auth.uid || isAdmin());
      allow delete: if isAuthenticated() && 
        (resource.data.authorId == request.auth.uid || isAdmin());
    }

    match /forum_posts/{postId} {
      allow read: if true;
      allow create: if isAuthenticated() && 
        request.resource.data.authorId == request.auth.uid;
      allow update: if isAuthenticated() && 
        resource.data.authorId == request.auth.uid;
      allow delete: if isAuthenticated() && 
        (resource.data.authorId == request.auth.uid || isAdmin());
    }

    match /forum_categories/{categoryId} {
      allow read: if true;
      allow write: if isAdmin(); // Only admins can manage categories
    }

    // ========== DEFAULT DENY ==========
    match /{document=**} {
      allow read, write: if false;
    }
  }
}