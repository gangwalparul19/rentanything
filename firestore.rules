rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========== HELPER FUNCTIONS ==========
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // ========== ADMIN EMAIL CHECK ==========
    // Update this list with authorized admin email addresses
    function isAdmin() {
      return request.auth != null && request.auth.token.email in [
        'gangwalparul19@gmail.com',  // Primary Admin
        // Add more admin emails here as needed:
        'rentanythingindia@gmail.com'
      ];
    }

    // ========== USERS COLLECTION ========== 
    // TIGHTENED: Protect Personal Identifiable Information (PII)
    match /users/{userId} {
      // Get: Users can read their own profile, admins can read any profile
      allow get: if isAuthenticated() && (
        isOwner(userId) || 
        isAdmin()
      );
      
      // List queries: Admins can list all users (for dashboard/stats)
      // Regular users CANNOT enumerate users
      allow list: if isAuthenticated() && isAdmin();
      
      // Create: Only the user themselves can create their profile
      allow create: if isAuthenticated() && 
        request.auth.uid == userId &&
        // Ensure they don't set admin flags themselves
        (!request.resource.data.keys().hasAny(['isAdmin', 'role']) || 
         request.resource.data.get('isAdmin', false) == false);
      
      // Update: Users can only update their own profile
      allow update: if isAuthenticated() && (
        isOwner(userId) ||
        isAdmin()
      ) &&
      // Prevent users from elevating their own privileges
      (!('isAdmin' in request.resource.data) || 
       request.resource.data.isAdmin == resource.data.get('isAdmin', false) ||
       isAdmin());
      
      // Delete: Only user themselves or admin
      allow delete: if isOwner(userId) || isAdmin();
    }
    
    // Public user profiles (limited fields only - no PII)
    match /public_profiles/{userId} {
      allow read: if true; // Anyone can read public profiles
      allow write: if isOwner(userId) || isAdmin();
    }
    
    // ========== LISTINGS COLLECTION ==========
    match /listings/{listingId} {
      allow read: if true; // Public listings
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin() || 
        (isAuthenticated() && resource.data.ownerId == request.auth.uid);
    }
    
    // ========== BOOKINGS COLLECTION ==========
    // TIGHTENED: Only involved parties can access booking data (contains payment info, addresses, etc.)
    match /bookings/{bookingId} {
      // Read: ONLY the renter, owner, or admin can read a booking
      allow read: if isAuthenticated() && (
        resource.data.renterId == request.auth.uid ||
        resource.data.ownerId == request.auth.uid ||
        isAdmin()
      );
      
      // Create: Only authenticated users, must be the renter
      allow create: if isAuthenticated() && 
        request.resource.data.renterId == request.auth.uid &&
        // Validate required fields exist to prevent incomplete data
        request.resource.data.keys().hasAll([
          'renterId', 'ownerId', 'listingId', 
          'startDate', 'endDate', 'status'
        ]);
      
      // Update: Only involved parties can update
      allow update: if isAuthenticated() && (
        // Renter can update (e.g., cancel)
        resource.data.renterId == request.auth.uid ||
        // Owner can update (e.g., approve/reject)
        resource.data.ownerId == request.auth.uid ||
        // Admin can moderate
        isAdmin()
      ) &&
      // Prevent tampering with critical fields
      (
        // Status changes are allowed
        request.resource.data.renterId == resource.data.renterId &&
        request.resource.data.ownerId == resource.data.ownerId &&
        request.resource.data.listingId == resource.data.listingId
      );
      
      // Delete: Only admin (for audit trail purposes)
      allow delete: if isAdmin();
    }

    // ========== REVIEWS COLLECTION ==========
    match /reviews/{reviewId} {
      allow read: if true; // Public reviews
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin(); // Admins can moderate reviews
    }

    // ========== SOCIETIES COLLECTION ==========
    match /societies/{societyId} {
      allow read: if true;
      allow write: if isAuthenticated() || isAdmin();
    }

    // ========== SOCIETY REQUESTS COLLECTION ==========
    match /society_requests/{requestId} {
      allow read, write: if isAuthenticated() || isAdmin();
    }

    // ========== COMMUNITY REQUESTS COLLECTION ==========
    match /requests/{requestId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if (isAuthenticated() && resource.data.userId == request.auth.uid) || isAdmin();
    }

    // ========== CHATS COLLECTION ==========
match /chats/{chatId} {
  // Allow creation if the sender is one of the participants
  allow create: if request.auth != null && 
    request.auth.uid in request.resource.data.participants;

  // FIX: Allow 'get' if document is null (for existence checks) 
  // or if user is a participant. 'list' is for the sidebar query.
  allow get: if request.auth != null && (resource == null || request.auth.uid in resource.data.participants || isAdmin());
  allow list: if request.auth != null && (request.auth.uid in resource.data.participants || isAdmin());
  
  allow update: if request.auth != null && (request.auth.uid in resource.data.participants || isAdmin());

  // Subcollection for messages
  match /messages/{messageId} {
    // FIX: Simplified read/create check for messages
    allow read, create: if request.auth != null && 
      get(/databases/$(database)/documents/chats/$(chatId)).data.participants != null &&
      request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
  }
}

    // ========== NOTIFICATIONS COLLECTION ==========
    match /notifications/{notificationId} {
      allow create: if isAuthenticated();
      allow read, update, delete: if (isAuthenticated() && 
        resource.data.userId == request.auth.uid) || isAdmin();
    }

    // ========== FCM TOKENS COLLECTION ==========
    match /fcm_tokens/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // ========== FAVORITES COLLECTION ==========
    match /favorites/{favoriteId} {
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      allow read, delete: if (isAuthenticated() && 
        resource.data.userId == request.auth.uid) || isAdmin();
    }

    // ========== WISHLISTS COLLECTION ==========
    match /wishlists/{wishlistId} {
      allow create: if isAuthenticated() && 
        wishlistId.matches('^' + request.auth.uid + '_[a-zA-Z0-9]+$');
      allow read, update, delete: if (isAuthenticated() && 
        resource.data.userId == request.auth.uid) || isAdmin();
    }

    // ========== WAITLISTS COLLECTION ==========
    match /waitlists/{waitlistId} {
      allow create: if isAuthenticated() && 
        waitlistId.matches('^' + request.auth.uid + '_[a-zA-Z0-9]+$');
      allow read, update, delete: if (isAuthenticated() && 
        resource.data.userId == request.auth.uid) || isAdmin();
    }

    // ========== DISPUTES COLLECTION ==========
    match /disputes/{disputeId} {
      // Users can read disputes they're involved in, Admins can read all
      allow read: if isAdmin() || 
        (isAuthenticated() && 
         (resource.data.reporterId == request.auth.uid || 
          resource.data.respondentId == request.auth.uid));
      
      // Users can create disputes for their own bookings
      allow create: if isAuthenticated() && 
        request.resource.data.reporterId == request.auth.uid;
      
      // Only admins can update disputes (mediation)
      allow update: if isAdmin();
      
      // No one can delete disputes (audit trail)
      allow delete: if false;
    }

    // ========== REPORTS COLLECTION ==========
    match /reports/{reportId} {
      allow create: if isAuthenticated();
      allow read: if isAdmin() || 
        (isAuthenticated() && resource.data.reporterId == request.auth.uid);
      allow update, delete: if isAdmin(); // Admins can manage all reports
    }

    // ========== SHARE ANALYTICS COLLECTION ==========
    match /share_analytics/{shareId} {
      allow create: if true; // Anyone can track shares (including anonymous)
      allow read: if isAdmin(); // Only admins can view analytics
    }

    // ========== ENVIRONMENTAL IMPACT COLLECTIONS ==========
    match /environmental_impact/{impactId} {
      allow create: if isAuthenticated();
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow read: if isAdmin(); // Admins can view all
    }

    match /user_eco_profile/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && userId == request.auth.uid;
    }

    // ========== STATS COLLECTIONS (WIDE OPEN FOR INIT - DELETE AFTER!) ==========
    // Platform-wide statistics (aggregated counts)
    match /stats/platform_stats {
      // Anyone can read stats (for public dashboards)
      allow read: if true;
      // WIDE OPEN: No auth required (DELETE THIS PAGE AFTER INIT!)
      allow write: if true;
    }
    
    // User-specific stats
    match /stats/user_stats/{userId} {
      // Users can read their own stats, admins can read all
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      // WIDE OPEN: No auth required (RESTORE SECURITY AFTER!)
      allow write: if true;
    }

    match /platform_stats/{statId} {
      allow read: if true; // Public stats
      allow write: if isAuthenticated(); // Users can increment
    }

    // ========== COMMUNITY FORUMS COLLECTIONS ==========
    match /forum_threads/{threadId} {
      allow read: if true; // Public within app
      allow create: if isAuthenticated() && 
        request.resource.data.authorId == request.auth.uid;
      allow update: if isAuthenticated() && 
        (resource.data.authorId == request.auth.uid || isAdmin());
      allow delete: if isAuthenticated() && 
        (resource.data.authorId == request.auth.uid || isAdmin());
    }

    match /forum_posts/{postId} {
      allow read: if true;
      allow create: if isAuthenticated() && 
        request.resource.data.authorId == request.auth.uid;
      allow update: if isAuthenticated() && 
        resource.data.authorId == request.auth.uid;
      allow delete: if isAuthenticated() && 
        (resource.data.authorId == request.auth.uid || isAdmin());
    }
    // Property approvals (admin only)
    match /property_approvals/{propertyId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // FCM Tokens - allow users to save their own notification tokens
    match /fcm_tokens/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    match /forum_categories/{categoryId} {
      allow read: if true;
      allow write: if isAdmin(); // Only admins can manage categories
    }

    // ========== DEFAULT DENY ==========
    match /{document=**} {
      allow read, write: if false;
    }
    
    // RENTAL PROPERTIES
    match /properties/{propertyId} {
      // Anyone can read available properties
      allow read: if resource.data.status == 'available' || 
                     (request.auth != null && resource.data.ownerId == request.auth.uid);
      
      // Only authenticated users can create properties
      allow create: if request.auth != null 
        && request.resource.data.ownerId == request.auth.uid
        && request.resource.data.status in ['available', 'rented'];
      
      // Only property owner can update or delete
      allow update, delete: if request.auth != null 
        && resource.data.ownerId == request.auth.uid;
    }
    
    // Property Inquiries
    match /property_inquiries/{inquiryId} {
      // Users can create inquiries for available properties
      allow create: if request.auth != null
        && request.resource.data.userId == request.auth.uid;
      
      // Inquiry creator and property owner can read
      allow read: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        get(/databases/$(database)/documents/properties/$(resource.data.propertyId)).data.ownerId == request.auth.uid
      );
      
      // Inquiry creator can update their own inquiry (e.g., cancel/withdraw)
      // Property owner can also update inquiry status (e.g., approve/reject)
      allow update: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        get(/databases/$(database)/documents/properties/$(resource.data.propertyId)).data.ownerId == request.auth.uid
      );
    }
  }
}